// Generated by CoffeeScript 1.6.2
(function() {
  var map, meMarker,
    _this = this;

  map = L.mapbox.map('map', 'karenishe.map-pxxvu0dq', {
    detectRetina: true,
    retinaVersion: 'karenishe.map-2s2oc75l'
  }).addControl(L.mapbox.shareControl()).addControl(L.mapbox.geocoderControl('karenishe.map-pxxvu0dq'));

  meMarker = null;

  if (navigator.geolocation) {
    map.on('locationfound', function(e) {
      if (Math.abs(e.latitude - 52.373) < .1 && Math.abs(e.longitude - 4.893) < .1) {
        map.fitBounds(e.bounds);
        meMarker = L.marker(new L.LatLng(e.latlng.lat, e.latlng.lng), {
          icon: L.mapbox.marker.icon({
            'marker-color': 'bb0000',
            'marker-symbol': 'star-stroked',
            "marker-size": 'large'
          }),
          draggable: true
        });
        return meMarker.addTo(map);
      }
    });
    map.on('locationerror', function() {});
    map.locate();
  } else {
    map.setView([52.373, 4.893], 14);
  }

  L.mapbox.markerLayer().addTo(map).on('ready', function(e) {
    return e.target.eachLayer(function(marker) {
      var content;

      content = ("<h1>" + marker.feature.properties.title + "</h1>") + (marker.feature.properties.address ? "<p class='address'>" + marker.feature.properties.address + "</p>" : '') + (marker.feature.properties.phone ? "<p class='phone'>" + marker.feature.properties.phone + "</p>" : '') + (marker.feature.properties.url ? "<a href='http://" + marker.feature.properties.url + "' target='_blank' class='url'>www." + marker.feature.properties.url + "</a>" : '') + ("<iframe src='marker_counter.html?marker_id=" + marker.feature.properties.id + "' class='iframe'></iframe>");
      return marker.bindPopup(content, {
        closeButton: true,
        maxWidth: 200
      });
    });
  }).loadURL('markers.geojson');

}).call(this);
